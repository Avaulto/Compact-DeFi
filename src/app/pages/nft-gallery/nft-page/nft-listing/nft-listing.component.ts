import { animate, state, style, transition, trigger } from '@angular/animations';
import { Component, Input, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { WalletStore } from '@heavy-duty/wallet-adapter';
import { TOKEN_PROGRAM_ID } from '@solana/spl-token';
import { PublicKey, Signer, Transaction } from '@solana/web3.js';
import { firstValueFrom } from 'rxjs';
import { Nft } from 'src/app/models';
import { SolanaUtilsService, TxInterceptService, UtilsService } from 'src/app/services';
import { NftStoreService } from 'src/app/services/nft-store.service';

@Component({
  selector: 'app-nft-listing',
  templateUrl: './nft-listing.component.html',
  styleUrls: ['./nft-listing.component.scss']
})
export class NftListingComponent implements OnInit {
  @Input() nft: Nft;
  public listNftForm: FormGroup = {} as FormGroup;
  public formSubmitted: boolean = false;
  public showDates:boolean = false;
  public expiryPlaceholder: string = 'no expiry';
  public minimumExpiry = new Date().toISOString()

  constructor(
    private _walletStore: WalletStore,
    private _nftStoreService: NftStoreService,
    private txInterceptService: TxInterceptService,
    private utilService:UtilsService,
    private fb: FormBuilder
  ) { 
    // console.log(walletOwner,auctionHouseAddress,associatedTokenAddress)
    this.listNftForm = this.fb.group({
      sellerAddress: [],
      tokenMint:[],
      tokenAccount:[],
      auctionHouseAddress: [],
      sol: ['', [Validators.required]],
      expiry: ['']
    })
  }

  async findAssociatedTokenAddress(
    walletAddress: PublicKey,
    tokenMintAddress: PublicKey
): Promise<PublicKey> {
  const SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID: PublicKey = new PublicKey(
    'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL',
  );
    return (await PublicKey.findProgramAddress(
        [
            walletAddress.toBuffer(),
            TOKEN_PROGRAM_ID.toBuffer(),
            tokenMintAddress.toBuffer(),
        ],
        SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID
    ))[0];
}
  async ngOnInit() {
    
    this.initFormSetup();
    this.listNftForm.controls.expiry.valueChanges.subscribe(val =>{
      if(val == ''){
        this.expiryPlaceholder ='no expiry'; 
      }else{
        this.expiryPlaceholder = val.split('T')[0];
      }
      this.showDates = false;
    })
  }
  private async initFormSetup(){
    const walletOwner = await (await firstValueFrom(this._walletStore.anchorWallet$)).publicKey;
    const auctionHouseAddress =( await this._nftStoreService.getCollectionMarketplaceData(this.nft.collection)).auctionHouse;
    const mintAddressPK = new PublicKey(this.nft.mintAddress)
    const associatedTokenAddress = await (await this.findAssociatedTokenAddress(walletOwner,mintAddressPK))

    this.listNftForm.controls.sellerAddress.setValue(walletOwner.toBase58())
    this.listNftForm.controls.tokenMint.setValue(mintAddressPK.toBase58())
    this.listNftForm.controls.tokenAccount.setValue(associatedTokenAddress.toBase58())
    this.listNftForm.controls.auctionHouseAddress.setValue(auctionHouseAddress)

  }
  public async listNft(): Promise<void>{
    const listInfo = this.listNftForm.value;
    console.log(listInfo)
    const txIns: {tx: any, txSigned:any} = await this._nftStoreService.listNft(listInfo)
    const walletOwner = await (await firstValueFrom(this._walletStore.anchorWallet$)).publicKey;
    const txInst = {
      "tx": {
          "type": "Buffer",
          "data": [
              2,
              1,
              10,
              14,
              4,
              116,
              54,
              114,
              219,
              249,
              97,
              71,
              218,
              13,
              12,
              132,
              125,
              103,
              104,
              30,
              59,
              204,
              124,
              254,
              252,
              229,
              206,
              23,
              20,
              92,
              42,
              103,
              161,
              55,
              71,
              216,
              5,
              127,
              54,
              85,
              153,
              40,
              206,
              27,
              171,
              173,
              182,
              91,
              139,
              93,
              158,
              49,
              186,
              39,
              248,
              83,
              155,
              236,
              96,
              44,
              203,
              26,
              220,
              42,
              251,
              159,
              70,
              112,
              15,
              208,
              17,
              96,
              46,
              95,
              152,
              15,
              67,
              21,
              30,
              18,
              64,
              129,
              15,
              81,
              226,
              231,
              149,
              67,
              218,
              96,
              250,
              22,
              5,
              18,
              70,
              77,
              65,
              246,
              190,
              147,
              8,
              62,
              182,
              6,
              229,
              63,
              156,
              165,
              47,
              204,
              223,
              31,
              129,
              101,
              145,
              63,
              246,
              29,
              253,
              203,
              213,
              131,
              198,
              96,
              188,
              146,
              78,
              32,
              209,
              57,
              207,
              139,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              11,
              227,
              225,
              235,
              161,
              122,
              71,
              63,
              137,
              176,
              247,
              232,
              226,
              73,
              64,
              242,
              10,
              235,
              142,
              188,
              167,
              26,
              136,
              253,
              233,
              93,
              75,
              131,
              183,
              26,
              9,
              143,
              185,
              74,
              73,
              232,
              5,
              112,
              253,
              58,
              94,
              94,
              16,
              132,
              136,
              186,
              175,
              132,
              78,
              194,
              124,
              40,
              241,
              54,
              240,
              38,
              236,
              251,
              125,
              45,
              170,
              214,
              249,
              140,
              151,
              37,
              143,
              78,
              36,
              137,
              241,
              187,
              61,
              16,
              41,
              20,
              142,
              13,
              131,
              11,
              90,
              19,
              153,
              218,
              255,
              16,
              132,
              4,
              142,
              123,
              216,
              219,
              233,
              248,
              89,
              8,
              175,
              246,
              228,
              16,
              89,
              36,
              102,
              175,
              155,
              72,
              107,
              229,
              118,
              121,
              242,
              246,
              139,
              65,
              205,
              220,
              49,
              224,
              32,
              146,
              119,
              74,
              143,
              99,
              98,
              237,
              19,
              195,
              27,
              24,
              204,
              62,
              20,
              138,
              10,
              82,
              147,
              129,
              137,
              32,
              237,
              250,
              237,
              171,
              57,
              30,
              73,
              51,
              108,
              11,
              116,
              219,
              102,
              157,
              16,
              71,
              3,
              66,
              75,
              199,
              142,
              61,
              179,
              227,
              207,
              227,
              5,
              41,
              236,
              68,
              223,
              213,
              109,
              168,
              162,
              193,
              3,
              23,
              201,
              230,
              2,
              172,
              43,
              145,
              168,
              31,
              156,
              18,
              96,
              77,
              205,
              5,
              33,
              159,
              137,
              154,
              129,
              212,
              255,
              132,
              251,
              89,
              61,
              46,
              223,
              138,
              144,
              172,
              27,
              58,
              179,
              66,
              88,
              247,
              223,
              35,
              62,
              165,
              3,
              2,
              177,
              189,
              46,
              6,
              167,
              213,
              23,
              25,
              44,
              92,
              81,
              33,
              140,
              201,
              76,
              61,
              74,
              241,
              127,
              88,
              218,
              238,
              8,
              155,
              161,
              253,
              68,
              227,
              219,
              217,
              138,
              0,
              0,
              0,
              0,
              6,
              221,
              246,
              225,
              215,
              101,
              161,
              147,
              217,
              203,
              225,
              70,
              206,
              235,
              121,
              172,
              28,
              180,
              133,
              237,
              95,
              91,
              55,
              145,
              58,
              140,
              245,
              133,
              126,
              255,
              0,
              169,
              25,
              99,
              207,
              102,
              219,
              15,
              7,
              142,
              53,
              150,
              164,
              70,
              170,
              137,
              23,
              197,
              191,
              64,
              186,
              73,
              51,
              163,
              119,
              22,
              247,
              212,
              155,
              9,
              253,
              230,
              165,
              208,
              1,
              11,
              15,
              0,
              1,
              2,
              2,
              6,
              10,
              8,
              9,
              3,
              8,
              13,
              4,
              7,
              5,
              12,
              34,
              51,
              230,
              133,
              164,
              1,
              127,
              131,
              173,
              255,
              250,
              0,
              232,
              118,
              72,
              23,
              0,
              0,
              0,
              1,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              255,
              255,
              255,
              255,
              255,
              255,
              255,
              255
          ]
      },
      "txSigned": {
          "type": "Buffer",
          "data": [
              2,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              224,
              238,
              20,
              36,
              108,
              13,
              198,
              108,
              74,
              231,
              238,
              229,
              8,
              101,
              148,
              103,
              218,
              11,
              233,
              236,
              65,
              214,
              64,
              55,
              40,
              19,
              125,
              105,
              75,
              36,
              181,
              136,
              110,
              75,
              198,
              179,
              222,
              209,
              121,
              138,
              203,
              241,
              16,
              97,
              0,
              162,
              206,
              186,
              156,
              105,
              72,
              13,
              80,
              171,
              151,
              133,
              239,
              227,
              4,
              141,
              208,
              169,
              78,
              10,
              2,
              1,
              10,
              14,
              4,
              116,
              54,
              114,
              219,
              249,
              97,
              71,
              218,
              13,
              12,
              132,
              125,
              103,
              104,
              30,
              59,
              204,
              124,
              254,
              252,
              229,
              206,
              23,
              20,
              92,
              42,
              103,
              161,
              55,
              71,
              216,
              5,
              127,
              54,
              85,
              153,
              40,
              206,
              27,
              171,
              173,
              182,
              91,
              139,
              93,
              158,
              49,
              186,
              39,
              248,
              83,
              155,
              236,
              96,
              44,
              203,
              26,
              220,
              42,
              251,
              159,
              70,
              112,
              15,
              208,
              17,
              96,
              46,
              95,
              152,
              15,
              67,
              21,
              30,
              18,
              64,
              129,
              15,
              81,
              226,
              231,
              149,
              67,
              218,
              96,
              250,
              22,
              5,
              18,
              70,
              77,
              65,
              246,
              190,
              147,
              8,
              62,
              182,
              6,
              229,
              63,
              156,
              165,
              47,
              204,
              223,
              31,
              129,
              101,
              145,
              63,
              246,
              29,
              253,
              203,
              213,
              131,
              198,
              96,
              188,
              146,
              78,
              32,
              209,
              57,
              207,
              139,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              11,
              227,
              225,
              235,
              161,
              122,
              71,
              63,
              137,
              176,
              247,
              232,
              226,
              73,
              64,
              242,
              10,
              235,
              142,
              188,
              167,
              26,
              136,
              253,
              233,
              93,
              75,
              131,
              183,
              26,
              9,
              143,
              185,
              74,
              73,
              232,
              5,
              112,
              253,
              58,
              94,
              94,
              16,
              132,
              136,
              186,
              175,
              132,
              78,
              194,
              124,
              40,
              241,
              54,
              240,
              38,
              236,
              251,
              125,
              45,
              170,
              214,
              249,
              140,
              151,
              37,
              143,
              78,
              36,
              137,
              241,
              187,
              61,
              16,
              41,
              20,
              142,
              13,
              131,
              11,
              90,
              19,
              153,
              218,
              255,
              16,
              132,
              4,
              142,
              123,
              216,
              219,
              233,
              248,
              89,
              8,
              175,
              246,
              228,
              16,
              89,
              36,
              102,
              175,
              155,
              72,
              107,
              229,
              118,
              121,
              242,
              246,
              139,
              65,
              205,
              220,
              49,
              224,
              32,
              146,
              119,
              74,
              143,
              99,
              98,
              237,
              19,
              195,
              27,
              24,
              204,
              62,
              20,
              138,
              10,
              82,
              147,
              129,
              137,
              32,
              237,
              250,
              237,
              171,
              57,
              30,
              73,
              51,
              108,
              11,
              116,
              219,
              102,
              157,
              16,
              71,
              3,
              66,
              75,
              199,
              142,
              61,
              179,
              227,
              207,
              227,
              5,
              41,
              236,
              68,
              223,
              213,
              109,
              168,
              162,
              193,
              3,
              23,
              201,
              230,
              2,
              172,
              43,
              145,
              168,
              31,
              156,
              18,
              96,
              77,
              205,
              5,
              33,
              159,
              137,
              154,
              129,
              212,
              255,
              132,
              251,
              89,
              61,
              46,
              223,
              138,
              144,
              172,
              27,
              58,
              179,
              66,
              88,
              247,
              223,
              35,
              62,
              165,
              3,
              2,
              177,
              189,
              46,
              6,
              167,
              213,
              23,
              25,
              44,
              92,
              81,
              33,
              140,
              201,
              76,
              61,
              74,
              241,
              127,
              88,
              218,
              238,
              8,
              155,
              161,
              253,
              68,
              227,
              219,
              217,
              138,
              0,
              0,
              0,
              0,
              6,
              221,
              246,
              225,
              215,
              101,
              161,
              147,
              217,
              203,
              225,
              70,
              206,
              235,
              121,
              172,
              28,
              180,
              133,
              237,
              95,
              91,
              55,
              145,
              58,
              140,
              245,
              133,
              126,
              255,
              0,
              169,
              25,
              99,
              207,
              102,
              219,
              15,
              7,
              142,
              53,
              150,
              164,
              70,
              170,
              137,
              23,
              197,
              191,
              64,
              186,
              73,
              51,
              163,
              119,
              22,
              247,
              212,
              155,
              9,
              253,
              230,
              165,
              208,
              1,
              11,
              15,
              0,
              1,
              2,
              2,
              6,
              10,
              8,
              9,
              3,
              8,
              13,
              4,
              7,
              5,
              12,
              34,
              51,
              230,
              133,
              164,
              1,
              127,
              131,
              173,
              255,
              250,
              0,
              232,
              118,
              72,
              23,
              0,
              0,
              0,
              1,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              255,
              255,
              255,
              255,
              255,
              255,
              255,
              255
          ]
      }
  }
    const txn = Transaction.from(Buffer.from(txInst.txSigned.data));
    // const signer = Transaction.from(Buffer.from(txInst.tx.data))
    // const txn2 = Transaction.from(Buffer.from(txIns.tx))
    console.log(txn)
    this.txInterceptService.sendTx([txn],walletOwner)
  }
  public async cancelNftListing(): Promise<void>{
    const listInfo = this.listNftForm.value;
    const txIns: {tx: any, txSigned:any} = await this._nftStoreService.cancelNftListing(listInfo)
    const walletOwner = await (await firstValueFrom(this._walletStore.anchorWallet$)).publicKey;
    const txn = Transaction.from(Buffer.from(txIns.txSigned.data))
    // const txn2 = Transaction.from(Buffer.from(txIns.tx))
    console.log(txn,txIns)
    this.txInterceptService.sendTx([txn],walletOwner)
  }
}
